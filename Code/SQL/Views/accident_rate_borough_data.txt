CREATE OR REPLACE VIEW ACCIDENT_RATE_BOROUGH_DATA AS (

WITH

MostRecentDate AS(
    SELECT MAX(CRASH_DATE) AS MOST_RECENT_DATE
    FROM ACCIDENT_DATA
),
YearlyAccidentsByBoro AS(
    SELECT BOROUGH, YEAR(CRASH_DATETIME) AS YEAR, COUNT(*) AS YEARLY_ACCIDENT_COUNT
    FROM ACCIDENT_DATA
    GROUP BY YEAR(crash_datetime), BOROUGH
),
MonthlyAccidentsByBoro AS(
    SELECT BOROUGH, MONTH(CRASH_DATETIME), COUNT(*) AS MONTHLY_ACCIDENT_COUNT
    FROM ACCIDENT_DATA
    GROUP BY YEAR(crash_datetime), MONTH(CRASH_DATETIME), BOROUGH
    ORDER BY YEAR(crash_datetime), MONTH(CRASH_DATETIME)
),
DailyAccidentsByBoro AS(
    SELECT BOROUGH, DAY(CRASH_DATETIME) AS DAY, COUNT(*) AS DAILY_ACCIDENT_COUNT
    FROM ACCIDENT_DATA
    GROUP BY DAY(CRASH_DATETIME), MONTH(CRASH_DATETIME), YEAR(CRASH_DATETIME), BOROUGH
    ORDER BY DAY(CRASH_DATETIME)
),
HourlyAccidentsByBoro AS(
    SELECT BOROUGH, HOUR(CRASH_DATETIME) AS HOUR, COUNT(*) AS HOURLY_ACCIDENT_COUNT
    FROM ACCIDENT_DATA
    GROUP BY HOUR(CRASH_DATETIME), DAY(CRASH_DATETIME), MONTH(CRASH_DATETIME), YEAR(CRASH_DATETIME), BOROUGH
    ORDER BY HOUR(CRASH_DATETIME)
),
AvgYearlyAccidentsByBoro AS(
    SELECT BOROUGH, AVG(YEARLY_ACCIDENT_COUNT) AS AVG_YEARLY_ACCIDENTS
    FROM YEARLYACCIDENTSBYBORO
    GROUP BY BOROUGH
),
AvgMonthlyAccidentsByBoro AS(
    SELECT BOROUGH, AVG(MONTHLY_ACCIDENT_COUNT) AS AVG_MONTHLY_ACCIDENTS
    FROM MONTHLYACCIDENTSBYBORO
    GROUP BY BOROUGH
),
AvgDailyAccidentsByBoro AS(
    SELECT BOROUGH, AVG(DAILY_ACCIDENT_COUNT) AS AVG_DAILY_ACCIDENTS
    FROM DAILYACCIDENTSBYBORO
    GROUP BY BOROUGH
),
AvgHourlyAccidentsByBoro AS(
    SELECT BOROUGH, AVG(HOURLY_ACCIDENT_COUNT) AS AVG_HOURLY_ACCIDENTS
    FROM HOURLYACCIDENTSBYBORO
    GROUP BY BOROUGH
)
SELECT AY.BOROUGH,

       ROUND(AY.AVG_YEARLY_ACCIDENTS) AS AVG_YEARLY_ACCIDENT_RATE,
       ROUND(AM.AVG_MONTHLY_ACCIDENTS) AS AVG_MONTHLY_ACCIDENT_RATE,
       ROUND(AD.AVG_DAILY_ACCIDENTS) AS AVG_DAILY_ACCIDENT_RATE,
       ROUND(AH.AVG_HOURLY_ACCIDENTS) AS AVG_HOURLY_ACCIDENT_RATE

       FROM AVGYEARLYACCIDENTSBYBORO AS AY
       JOIN AVGMONTHLYACCIDENTSBYBORO AS AM ON AY.BOROUGH = AM.BOROUGH
       JOIN AVGDAILYACCIDENTSBYBORO AS AD ON AY.BOROUGH = AD.BOROUGH
       JOIN AVGHOURLYACCIDENTSBYBORO AS AH ON AY.BOROUGH = AH.BOROUGH
);
