create or replace view CAPSTONE_DE.GROUP_4.ACCIDENT_RATE_BY_HOUR_VW(
	BOROUGH,
	HOUR,
	HOURLY_ACCIDENT_RATE
) as
(
    with
    
    HourlyAccidentsByBoro AS(
    SELECT BOROUGH, HOUR(CRASH_DATETIME) AS HOUR, COUNT(*) AS HOURLY_ACCIDENT_COUNT
    FROM ACCIDENT_DATA
    GROUP BY HOUR(CRASH_DATETIME), DAY(CRASH_DATETIME), MONTH(CRASH_DATETIME), YEAR(CRASH_DATETIME), BOROUGH
    ORDER BY HOUR(CRASH_DATETIME)
    ),
    AvgHourlyAccidentsByBoro AS(
    SELECT BOROUGH, HOUR, AVG(HOURLY_ACCIDENT_COUNT) AS HOURLY_ACCIDENT_RATE
    FROM HOURLYACCIDENTSBYBORO
    GROUP BY BOROUGH, HOUR
    ORDER BY BOROUGH, HOUR
    )
    select * from AvgHourlyAccidentsByBoro
);
