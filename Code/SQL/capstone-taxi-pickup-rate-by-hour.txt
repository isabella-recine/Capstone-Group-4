create or replace view CAPSTONE_DE.GROUP_4.TAXI_PICKUP_RATE_BY_HOUR_VW(
	BOROUGH,
	HOUR,
	HOURLY_PICKUP_RATE
) as
(
    with
    
    HourlyPickupsByBoro AS(
    SELECT BOROUGH, HOUR(PICKUP_DATETIME) AS HOUR, COUNT(*) AS HOURLY_PICKUP_COUNT
    FROM COMBINED_TAXI_DATA
    JOIN ZONE_TAXI_DATA AS Z ON Z.LOCATIONID = COMBINED_TAXI_DATA.PULOCATIONID
    GROUP BY HOUR(PICKUP_DATETIME), DAY(PICKUP_DATETIME), MONTH(PICKUP_DATETIME), YEAR(PICKUP_DATETIME), BOROUGH
    ORDER BY HOUR(PICKUP_DATETIME)
    ),
    AvgHourlyPickupsByBoro AS(
    SELECT BOROUGH, HOUR, AVG(HOURLY_PICKUP_COUNT) AS HOURLY_PICKUP_RATE
    FROM HOURLYPICKUPSBYBORO
    GROUP BY BOROUGH, HOUR
    ORDER BY BOROUGH, HOUR
    )
    select * from AvgHourlyPickupsByBoro
);
